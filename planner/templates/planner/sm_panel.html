{% extends 'planner/base.html' %}
{% block title %}SM Panel{% endblock %}
{% block content %}
<div class="container">
  <h1 style="font-size:1.4rem;font-weight:700;margin:16px 0 4px;">üëë Scrum Master Panel</h1>
  <p class="text-muted text-sm mb-4">Manage sprints, team members and stories</p>

  <div class="grid-2">

    <!-- Sprints -->
    <div style="grid-column:span 2;">
      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <div class="section-title" style="margin:0;">üìÖ Sprints</div>
          <button class="btn btn-primary btn-sm" onclick="openModal('addSprintModal')">+ New Sprint</button>
        </div>
        {% if sprints %}
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">
          {% for s in sprints %}
          <div style="background:var(--surface);border-radius:8px;padding:14px;border:1px solid {% if s.is_active %}var(--green){% else %}var(--border){% endif %};">
            <div class="flex items-center justify-between mb-2">
              <span style="font-weight:600;">{{ s.name }}</span>
              {% if s.is_active %}<span class="badge" style="background:#1a3320;color:var(--green);">üü¢ Active</span>{% endif %}
            </div>
            {% if s.goal %}<div class="text-sm text-muted mb-2">{{ s.goal }}</div>{% endif %}
            <div class="text-sm text-muted mb-3">
              {{ s.user_stories.count }} stories ¬∑ {{ s.total_sp }} SP
              {% if s.start_date %}<br>{{ s.start_date }} ‚Üí {{ s.end_date }}{% endif %}
            </div>
            <div class="flex gap-2">
              {% if not s.is_active %}
              <button class="btn btn-success btn-sm" onclick="setActiveSprint({{ s.id }})">Set Active</button>
              {% endif %}
              <button class="btn btn-ghost btn-sm" onclick="openEditSprint({{ s.id }}, '{{ s.name }}', '{{ s.goal }}', '{{ s.start_date }}', '{{ s.end_date }}', {{ s.is_active|yesno:'true,false' }})">‚úèÔ∏è Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteSprint({{ s.id }}, '{{ s.name }}')">üóëÔ∏è</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-muted text-sm">No sprints yet. Create your first sprint.</div>
        {% endif %}
      </div>
    </div>

    <!-- Team Members -->
    <div>
      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <div class="section-title" style="margin:0;">üë• Team Members ({{ members.count }})</div>
          <button class="btn btn-primary btn-sm" onclick="openModal('addMemberModal')">+ Add</button>
        </div>
        {% regroup members by stream as stream_groups %}
        {% for group in stream_groups %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1" style="font-weight:600;">{{ group.grouper }}</div>
          {% for m in group.list %}
          <div class="flex items-center justify-between" style="background:var(--surface);border-radius:6px;padding:8px 12px;margin-bottom:4px;">
            <span style="font-size:0.875rem;">{{ m.name }}</span>
            <button class="btn btn-danger btn-sm" onclick="removeMember({{ m.id }}, '{{ m.name }}')">Remove</button>
          </div>
          {% endfor %}
        </div>
        {% empty %}
        <div class="text-muted text-sm">No members yet.</div>
        {% endfor %}
      </div>
    </div>

    <!-- Bandwidth -->
    <div>
      <div class="card">
        <div class="section-title">üìä Bandwidth{% if active_sprint %} ‚Äî {{ active_sprint.name }}{% endif %}</div>
        {% for bw in bandwidth %}
        <div style="margin-bottom:12px;">
          <div class="flex items-center justify-between mb-1">
            <span style="font-size:0.85rem;">{{ bw.member.name }} <span class="badge badge-stream">{{ bw.member.stream }}</span></span>
            <span style="font-size:0.85rem;font-weight:700;color:{% if bw.over %}var(--red){% else %}var(--text){% endif %};">{{ bw.total }}/8 SP</span>
          </div>
          <div class="bandwidth-bar">
            <div class="bandwidth-fill" style="width:{% widthratio bw.total 8 100 %}%;background:{% if bw.over %}var(--red){% elif bw.total >= 6 %}var(--yellow){% else %}var(--green){% endif %};"></div>
          </div>
        </div>
        {% empty %}
        <div class="text-muted text-sm">No members yet.</div>
        {% endfor %}
      </div>
    </div>

    <!-- Stories -->
    <div style="grid-column:span 2;">
      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <div class="section-title" style="margin:0;">üìã All User Stories ({{ stories.count }})</div>
          <a href="{% url 'board' %}" class="btn btn-ghost btn-sm">View Board</a>
        </div>
        {% regroup stories by sprint as sprint_groups %}
        {% for group in sprint_groups %}
        <div class="mb-4">
          <div style="font-size:0.8rem;font-weight:700;color:var(--accent2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;padding:4px 0;border-bottom:1px solid var(--border);">
            üìÖ {% if group.grouper %}{{ group.grouper }}{% else %}No Sprint{% endif %}
          </div>
          {% for story in group.list %}
          <div style="background:var(--surface);border-radius:8px;padding:12px;margin-bottom:8px;border:1px solid var(--border);">
            <div class="flex items-center justify-between" style="flex-wrap:wrap;gap:8px;">
              <div class="flex items-center gap-3">
                <div class="sp-chip {% if not story.final_sp %}none{% endif %}">{{ story.final_sp|default:"?" }}</div>
                <div>
                  <div style="font-weight:600;font-size:0.875rem;">{{ story.title }}</div>
                  <div class="text-sm text-muted">
                    {% if story.owner %}Owner: {{ story.owner.name }}{% else %}No owner{% endif %}
                    {% if story.vote_average %} ¬∑ Avg: {{ story.vote_average }}{% endif %}
                  </div>
                </div>
              </div>
              <div class="flex gap-2 flex-wrap">
                <span class="badge badge-{{ story.voting_status }}">{{ story.get_voting_status_display }}</span>
                <a href="{% url 'vote_room' story.id %}" class="btn btn-ghost btn-sm">üó≥Ô∏è Vote Room</a>
                {% if story.voting_status == 'pending' %}
                <button class="btn btn-success btn-sm" onclick="triggerVoting({{ story.id }})">‚ñ∂ Start</button>
                {% elif story.voting_status == 'voting' %}
                <button class="btn btn-warning btn-sm" onclick="closeVoting({{ story.id }})">üîí Close</button>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% empty %}
        <div class="text-muted text-sm">No stories yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Add Sprint Modal -->
<div class="modal-overlay" id="addSprintModal">
  <div class="modal">
    <h3>üìÖ New Sprint</h3>
    <div class="form-group"><label>Sprint Name *</label><input type="text" id="sprintName" placeholder="e.g. Sprint 42"></div>
    <div class="form-group"><label>Goal (optional)</label><textarea id="sprintGoal" rows="2" placeholder="What do we aim to deliver?"></textarea></div>
    <div class="grid-2" style="gap:12px;">
      <div class="form-group"><label>Start Date</label><input type="date" id="sprintStart"></div>
      <div class="form-group"><label>End Date</label><input type="date" id="sprintEnd"></div>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--text);">
        <input type="checkbox" id="sprintActive" style="width:auto;"> Set as Active Sprint
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addSprintModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddSprint()">Create Sprint</button>
    </div>
  </div>
</div>

<!-- Edit Sprint Modal -->
<div class="modal-overlay" id="editSprintModal">
  <div class="modal">
    <h3>‚úèÔ∏è Edit Sprint</h3>
    <input type="hidden" id="editSprintId">
    <div class="form-group"><label>Sprint Name *</label><input type="text" id="editSprintName"></div>
    <div class="form-group"><label>Goal</label><textarea id="editSprintGoal" rows="2"></textarea></div>
    <div class="grid-2" style="gap:12px;">
      <div class="form-group"><label>Start Date</label><input type="date" id="editSprintStart"></div>
      <div class="form-group"><label>End Date</label><input type="date" id="editSprintEnd"></div>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--text);">
        <input type="checkbox" id="editSprintActive" style="width:auto;"> Active Sprint
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('editSprintModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitEditSprint()">Save</button>
    </div>
  </div>
</div>

<!-- Add Member Modal -->
<div class="modal-overlay" id="addMemberModal">
  <div class="modal">
    <h3>‚ûï Add Team Member</h3>
    <div class="form-group"><label>Full Name *</label><input type="text" id="memberName" placeholder="e.g. Ahmed Al-Rashid"></div>
    <div class="form-group">
      <label>Stream *</label>
      <select id="memberStream">
        <option value="">-- Select Stream --</option>
        {% for s in streams %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addMemberModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddMember()">Add Member</button>
    </div>
  </div>
</div>

<script>
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

async function submitAddSprint() {
  const name = document.getElementById('sprintName').value.trim();
  if (!name) { toast('Sprint name required', 'error'); return; }
  const res = await api('/sm/sprints/add/', 'POST', {
    name,
    goal: document.getElementById('sprintGoal').value,
    start_date: document.getElementById('sprintStart').value || null,
    end_date: document.getElementById('sprintEnd').value || null,
    is_active: document.getElementById('sprintActive').checked,
  });
  if (res.ok) { toast('Sprint created!', 'success'); closeModal('addSprintModal'); location.reload(); }
  else toast(res.error, 'error');
}

function openEditSprint(id, name, goal, start, end, isActive) {
  document.getElementById('editSprintId').value = id;
  document.getElementById('editSprintName').value = name;
  document.getElementById('editSprintGoal').value = goal === 'None' ? '' : goal;
  document.getElementById('editSprintStart').value = start === 'None' ? '' : start;
  document.getElementById('editSprintEnd').value = end === 'None' ? '' : end;
  document.getElementById('editSprintActive').checked = isActive;
  openModal('editSprintModal');
}

async function submitEditSprint() {
  const id = document.getElementById('editSprintId').value;
  const res = await api(`/sm/sprints/${id}/edit/`, 'POST', {
    name: document.getElementById('editSprintName').value,
    goal: document.getElementById('editSprintGoal').value,
    start_date: document.getElementById('editSprintStart').value || null,
    end_date: document.getElementById('editSprintEnd').value || null,
    is_active: document.getElementById('editSprintActive').checked,
  });
  if (res.ok) { toast('Saved!', 'success'); closeModal('editSprintModal'); location.reload(); }
  else toast(res.error, 'error');
}

async function setActiveSprint(id) {
  const res = await api(`/sm/sprints/${id}/edit/`, 'POST', { is_active: true });
  if (res.ok) { toast('Active sprint updated!', 'success'); location.reload(); }
}

async function deleteSprint(id, name) {
  if (!confirm(`Delete sprint "${name}"? Stories will remain but lose sprint assignment.`)) return;
  const res = await api(`/sm/sprints/${id}/delete/`, 'POST');
  if (res.ok) { toast('Sprint deleted', 'success'); location.reload(); }
}

async function submitAddMember() {
  const name = document.getElementById('memberName').value.trim();
  const stream = document.getElementById('memberStream').value;
  if (!name || !stream) { toast('Name and stream required', 'error'); return; }
  const formData = new FormData();
  formData.append('name', name);
  formData.append('stream', stream);
  formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
  const res = await fetch('/sm/members/add/', { method: 'POST', body: formData });
  const data = await res.json();
  if (data.ok) { toast(`${name} added!`, 'success'); closeModal('addMemberModal'); location.reload(); }
  else toast(data.error, 'error');
}

async function removeMember(id, name) {
  if (!confirm(`Remove ${name} from sprint team?`)) return;
  const res = await api(`/sm/members/${id}/remove/`, 'POST');
  if (res.ok) { toast(`${name} removed`, 'success'); location.reload(); }
}

async function triggerVoting(id) {
  if (!confirm('Start voting for this story?')) return;
  const res = await api(`/sm/stories/${id}/trigger-voting/`, 'POST');
  if (res.ok) { toast('Voting started!', 'success'); location.reload(); }
}

async function closeVoting(id) {
  const res = await api(`/sm/stories/${id}/close-voting/`, 'POST');
  if (res.ok) { toast('Voting closed. Avg: ' + res.average, 'success'); location.reload(); }
}
</script>
{% endblock %}
