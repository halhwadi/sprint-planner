{% extends 'planner/base.html' %}
{% block title %}Sprint Board{% endblock %}
{% block content %}
<div class="container">

  <!-- Sprint Selector Bar -->
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 20px;margin-top:16px;margin-bottom:20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
    <span class="text-muted text-sm" style="font-weight:600;">ğŸ“… SPRINT:</span>
    <a href="{% url 'board' %}" class="btn btn-sm {% if not selected_sprint %}btn-primary{% else %}btn-ghost{% endif %}">All</a>
    {% for s in sprints %}
    <a href="{% url 'board' %}?sprint={{ s.id }}" 
       class="btn btn-sm {% if selected_sprint.id == s.id %}btn-primary{% else %}btn-ghost{% endif %}">
      {{ s.name }}{% if s.is_active %} ğŸŸ¢{% endif %}
    </a>
    {% endfor %}
    {% if not sprints %}
    <span class="text-muted text-sm">No sprints yet â€” SM can create one</span>
    {% endif %}
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      {% if selected_sprint %}
      <span style="font-size:0.8rem;color:var(--muted);">
        {{ stories.count }} stories Â· {{ selected_sprint.total_sp }} SP total
        {% if selected_sprint.start_date %} Â· {{ selected_sprint.start_date }} â†’ {{ selected_sprint.end_date }}{% endif %}
      </span>
      {% endif %}
      {% if is_sm %}
      <button class="btn btn-primary btn-sm" onclick="openAddStory()">+ Add Story</button>
      {% endif %}
    </div>
  </div>

  <div class="grid-2">
    <!-- Bandwidth -->
    <div style="grid-column:span 2;">
      <div class="card" style="margin-bottom:20px;">
        <div class="section-title">ğŸ‘¥ Team Bandwidth (8 SP limit{% if selected_sprint %} â€” {{ selected_sprint.name }}{% endif %})</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
          {% for bw in bandwidth %}
          <div style="background:var(--surface);border-radius:8px;padding:12px;border:1px solid {% if bw.over %}var(--red){% else %}var(--border){% endif %};">
            <div class="flex items-center justify-between mb-2">
              <span style="font-size:0.85rem;font-weight:600;">{{ bw.member.name }}</span>
              <span class="badge badge-stream">{{ bw.member.stream }}</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="bandwidth-bar" style="flex:1;">
                <div class="bandwidth-fill" style="width:{% widthratio bw.total 8 100 %}%;background:{% if bw.over %}var(--red){% elif bw.total >= 6 %}var(--yellow){% else %}var(--green){% endif %};"></div>
              </div>
              <span style="font-size:0.8rem;font-weight:700;color:{% if bw.over %}var(--red){% else %}var(--text){% endif %};">{{ bw.total }}/8</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Stories -->
    <div style="grid-column:span 2;">
      {% if stories %}
      {% for story in stories %}
      <div class="card" id="story-{{ story.id }}">
        <div class="flex items-center justify-between" style="flex-wrap:wrap;gap:8px;">
          <div class="flex items-center gap-3" style="flex:1;">
            <div class="sp-chip {% if not story.final_sp %}none{% endif %}">{{ story.final_sp|default:"?" }}</div>
            <div>
              <div style="font-weight:600;font-size:0.95rem;">{{ story.title }}</div>
              {% if story.description %}<div class="text-sm text-muted mt-1">{{ story.description|truncatechars:100 }}</div>{% endif %}
              {% if story.sprint %}<div class="text-sm mt-1"><span class="tag">ğŸ“… {{ story.sprint.name }}</span></div>{% endif %}
            </div>
          </div>
          <div class="flex items-center gap-2" style="flex-wrap:wrap;">
            <span class="badge badge-{{ story.voting_status }}">
              {% if story.voting_status == 'pending' %}â³ Pending{% elif story.voting_status == 'voting' %}ğŸ—³ï¸ Voting{% else %}âœ… Closed{% endif %}
            </span>
            {% if story.owner %}<span class="badge" style="background:#1e3a5f;color:var(--blue);">ğŸ‘¤ {{ story.owner.name }}</span>{% endif %}
            <a href="{% url 'vote_room' story.id %}" class="btn btn-ghost btn-sm">
              {% if story.voting_status == 'voting' %}ğŸ—³ï¸ Vote{% else %}ğŸ‘ï¸ View{% endif %}
            </a>
            {% if is_sm %}
            <button class="btn btn-ghost btn-sm" onclick="openEditStory({{ story.id }})">âœï¸ Edit</button>
            <button class="btn btn-ghost btn-sm" onclick="openAssignSP({{ story.id }})">ğŸ¯ SP</button>
            {% endif %}
          </div>
        </div>
        {% if story.involved_streams %}
        <div class="mt-2">
          <span class="text-sm text-muted">Streams: </span>
          {% for s in story.involved_streams %}<span class="tag">{{ s }}</span>{% endfor %}
        </div>
        {% endif %}
        {% if story.stream_assignments.all %}
        <div class="mt-2" style="background:var(--surface);border-radius:8px;padding:10px;">
          <div class="text-sm text-muted mb-2">Stream Assignments:</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            {% for sa in story.stream_assignments.all %}
            <div style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:0.8rem;">
              <span class="tag">{{ sa.stream }}</span> {{ sa.member.name }} â€” <strong>{{ sa.sp }} SP</strong>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        {% if story.vote_average %}<div class="text-sm text-muted mt-2">Vote avg: <strong style="color:var(--accent2);">{{ story.vote_average }}</strong></div>{% endif %}
      </div>
      {% endfor %}
      {% else %}
      <div class="empty-state card">
        <div style="font-size:2.5rem;margin-bottom:12px;">ğŸ“­</div>
        <div>No user stories{% if selected_sprint %} in {{ selected_sprint.name }}{% endif %}.{% if is_sm %} Add one using the button above.{% endif %}</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add Story Modal -->
<div class="modal-overlay" id="addStoryModal">
  <div class="modal">
    <h3>â• Add User Story</h3>
    <div class="form-group">
      <label>Sprint</label>
      <select id="newSprint">
        <option value="">-- No sprint --</option>
        {% for s in sprints %}<option value="{{ s.id }}" {% if selected_sprint.id == s.id %}selected{% endif %}>{{ s.name }}{% if s.is_active %} ğŸŸ¢{% endif %}</option>{% endfor %}
      </select>
    </div>
    <div class="form-group"><label>Title *</label><input type="text" id="newTitle" placeholder="As a user..."></div>
    <div class="form-group"><label>Description</label><textarea id="newDesc" rows="3" placeholder="Optional details..."></textarea></div>
    <div class="form-group">
      <label>Owner</label>
      <select id="newOwner">
        <option value="">-- No owner yet --</option>
        {% for m in all_members %}<option value="{{ m.id }}">{{ m.name }} ({{ m.stream }})</option>{% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label>Involved Streams</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
        {% for s in streams %}
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer;color:var(--text);">
          <input type="checkbox" class="stream-check" value="{{ s }}" style="width:auto;"> {{ s }}
        </label>
        {% endfor %}
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addStoryModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddStory()">Add Story</button>
    </div>
  </div>
</div>

<!-- Edit Story Modal -->
<div class="modal-overlay" id="editStoryModal">
  <div class="modal">
    <h3>âœï¸ Edit User Story</h3>
    <input type="hidden" id="editStoryId">
    <div class="form-group">
      <label>Sprint</label>
      <select id="editSprint">
        <option value="">-- No sprint --</option>
        {% for s in sprints %}<option value="{{ s.id }}">{{ s.name }}{% if s.is_active %} ğŸŸ¢{% endif %}</option>{% endfor %}
      </select>
    </div>
    <div class="form-group"><label>Title *</label><input type="text" id="editTitle"></div>
    <div class="form-group"><label>Description</label><textarea id="editDesc" rows="3"></textarea></div>
    <div class="form-group">
      <label>Owner</label>
      <select id="editOwner">
        <option value="">-- No owner --</option>
        {% for m in all_members %}<option value="{{ m.id }}">{{ m.name }} ({{ m.stream }})</option>{% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label>Involved Streams</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
        {% for s in streams %}
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer;color:var(--text);">
          <input type="checkbox" class="edit-stream-check" value="{{ s }}" style="width:auto;"> {{ s }}
        </label>
        {% endfor %}
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="deleteStory()">ğŸ—‘ï¸ Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('editStoryModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitEditStory()">Save</button>
    </div>
  </div>
</div>

<!-- Assign SP Modal -->
<div class="modal-overlay" id="assignSPModal">
  <div class="modal">
    <h3>ğŸ¯ Assign Story Points</h3>
    <input type="hidden" id="assignStoryId">
    <div style="background:var(--surface);border-radius:8px;padding:12px;margin-bottom:16px;">
      <div class="text-sm text-muted">Vote Average: <strong id="voteAvgDisplay" style="color:var(--accent2);">â€”</strong></div>
    </div>
    <div class="form-group">
      <label>Final SP for User Story (assigned to owner)</label>
      <input type="number" id="finalSP" min="0" step="0.5" placeholder="e.g. 5">
    </div>
    <hr class="divider">
    <div class="section-title">Stream SP Assignments</div>
    <div id="streamAssignRows"></div>
    <button class="btn btn-ghost btn-sm mt-2" onclick="addStreamAssignRow()">+ Add Stream Assignment</button>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('assignSPModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAssignSP()">Save</button>
    </div>
  </div>
</div>

<script>
const ALL_MEMBERS = [{% for m in all_members %}{"id":{{m.id}},"name":"{{m.name}}","stream":"{{m.stream}}"},{% endfor %}];
const ALL_STREAMS = [{% for s in streams %}"{{s}}",{% endfor %}];

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openAddStory() {
  document.getElementById('newTitle').value = '';
  document.getElementById('newDesc').value = '';
  document.getElementById('newOwner').value = '';
  document.querySelectorAll('.stream-check').forEach(c => c.checked = false);
  openModal('addStoryModal');
}

async function submitAddStory() {
  const title = document.getElementById('newTitle').value.trim();
  if (!title) { toast('Title is required', 'error'); return; }
  const streams = [...document.querySelectorAll('.stream-check:checked')].map(c => c.value);
  const res = await api('/sm/stories/add/', 'POST', {
    title, description: document.getElementById('newDesc').value,
    owner_id: document.getElementById('newOwner').value || null,
    sprint_id: document.getElementById('newSprint').value || null,
    involved_streams: streams
  });
  if (res.ok) { toast('User story added!', 'success'); closeModal('addStoryModal'); location.reload(); }
  else toast(res.error, 'error');
}

async function openEditStory(id) {
  const res = await api(`/api/stories/${id}/`);
  document.getElementById('editStoryId').value = id;
  document.getElementById('editTitle').value = res.title;
  document.getElementById('editDesc').value = res.description;
  document.getElementById('editOwner').value = res.owner_id || '';
  document.getElementById('editSprint').value = res.sprint_id || '';
  document.querySelectorAll('.edit-stream-check').forEach(c => { c.checked = res.involved_streams.includes(c.value); });
  openModal('editStoryModal');
}

async function submitEditStory() {
  const id = document.getElementById('editStoryId').value;
  const streams = [...document.querySelectorAll('.edit-stream-check:checked')].map(c => c.value);
  const res = await api(`/sm/stories/${id}/edit/`, 'POST', {
    title: document.getElementById('editTitle').value,
    description: document.getElementById('editDesc').value,
    owner_id: document.getElementById('editOwner').value || null,
    sprint_id: document.getElementById('editSprint').value || null,
    involved_streams: streams
  });
  if (res.ok) { toast('Saved!', 'success'); closeModal('editStoryModal'); location.reload(); }
  else toast(res.error, 'error');
}

async function deleteStory() {
  if (!confirm('Delete this user story?')) return;
  const id = document.getElementById('editStoryId').value;
  const res = await api(`/sm/stories/${id}/delete/`, 'POST');
  if (res.ok) { toast('Deleted', 'success'); closeModal('editStoryModal'); location.reload(); }
}

let streamRowCount = 0;
async function openAssignSP(id) {
  document.getElementById('assignStoryId').value = id;
  const res = await api(`/api/stories/${id}/`);
  document.getElementById('finalSP').value = res.final_sp || '';
  document.getElementById('voteAvgDisplay').textContent = res.vote_average || 'â€”';
  const container = document.getElementById('streamAssignRows');
  container.innerHTML = '';
  streamRowCount = 0;
  res.stream_assignments.forEach(sa => addStreamAssignRow(sa.stream, sa.member_id, sa.sp));
  openModal('assignSPModal');
}

function addStreamAssignRow(stream='', memberId='', sp='') {
  const id = streamRowCount++;
  const memberOptions = ALL_MEMBERS.map(m => `<option value="${m.id}" ${m.id==memberId?'selected':''}>${m.name} (${m.stream})</option>`).join('');
  const streamOptions = ALL_STREAMS.map(s => `<option value="${s}" ${s==stream?'selected':''}>${s}</option>`).join('');
  const row = document.createElement('div');
  row.className = 'flex gap-2 mt-2 items-center';
  row.id = `srow-${id}`;
  row.innerHTML = `
    <select class="sa-stream" style="flex:1;">${streamOptions}</select>
    <select class="sa-member" style="flex:2;"><option value="">--Member--</option>${memberOptions}</select>
    <input type="number" class="sa-sp" value="${sp}" min="0" step="0.5" placeholder="SP" style="width:70px;">
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('srow-${id}').remove()">âœ•</button>`;
  document.getElementById('streamAssignRows').appendChild(row);
}

async function submitAssignSP() {
  const id = document.getElementById('assignStoryId').value;
  const finalSP = document.getElementById('finalSP').value;
  const rows = document.querySelectorAll('#streamAssignRows > div');
  const stream_assignments = [];
  for (const row of rows) {
    const stream = row.querySelector('.sa-stream').value;
    const member_id = row.querySelector('.sa-member').value;
    const sp = row.querySelector('.sa-sp').value;
    if (stream && member_id && sp) stream_assignments.push({ stream, member_id: parseInt(member_id), sp: parseFloat(sp) });
  }
  const res = await api(`/sm/stories/${id}/assign-sp/`, 'POST', {
    final_sp: finalSP ? parseFloat(finalSP) : null,
    stream_assignments
  });
  if (res.ok) { toast('SP assigned!', 'success'); closeModal('assignSPModal'); location.reload(); }
  else toast(res.error, 'error');
}

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});
</script>
{% endblock %}
